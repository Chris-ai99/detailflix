name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (retry)
        shell: bash
        run: |
          set -euo pipefail
          REPO_URL="https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          TARGET_SHA="${{ github.sha }}"

          for attempt in {1..8}; do
            echo "Checkout attempt ${attempt}/8 for ${TARGET_SHA}"
            rm -rf .git
            git init .
            git remote add origin "${REPO_URL}"

            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${TARGET_SHA}"; then
              git checkout --force FETCH_HEAD
              echo "Checkout succeeded"
              exit 0
            fi

            echo "Checkout failed (attempt ${attempt})"
            sleep $((attempt * 10))
          done

          echo "Checkout failed after 8 attempts"
          exit 1

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Prepare release bundle
        run: |
          rm -rf release release.tar.gz
          mkdir -p release/.next
          STANDALONE_DIR="$(dirname "$(find .next/standalone -type f -name server.js ! -path '*/node_modules/*' | head -n 1)")"
          if [ -z "$STANDALONE_DIR" ]; then
            echo "Standalone server.js not found"
            exit 1
          fi
          cp -R "$STANDALONE_DIR"/. release/
          rm -f release/.env release/.env.* release/*.db release/*.db-shm release/*.db-wal
          rm -rf release/data
          cp -R .next/static release/.next/static
          if [ -d public ]; then cp -R public release/public; fi
          cp ecosystem.config.cjs release/ecosystem.config.cjs
          tar -czf release.tar.gz -C release .

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Upload bundle to VPS (retry)
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          set -euo pipefail
          for attempt in {1..6}; do
            echo "SCP upload attempt ${attempt}/6"
            if sshpass -p "$VPS_PASSWORD" scp \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=20 \
              release.tar.gz "$VPS_USER@$VPS_HOST:~/release.tar.gz"; then
              echo "Upload succeeded"
              exit 0
            fi
            echo "Upload failed (attempt ${attempt})"
            sleep $((attempt * 10))
          done
          echo "Upload failed after 6 attempts"
          exit 1

      - name: Deploy on VPS (retry)
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          set -euo pipefail
          REMOTE_CMD='set -euo pipefail; APP_DIR="/var/www/detailflix"; RELEASE_TAR="$HOME/release.tar.gz"; STAGING_DIR="$HOME/detailflix-release"; mkdir -p "$APP_DIR"; rm -rf "$STAGING_DIR"; mkdir -p "$STAGING_DIR"; tar -xzf "$RELEASE_TAR" -C "$STAGING_DIR"; if command -v rsync >/dev/null 2>&1; then rsync -a --delete --exclude ".env" --exclude "data" "$STAGING_DIR"/ "$APP_DIR"/; else find "$APP_DIR" -mindepth 1 -maxdepth 1 ! -name ".env" ! -name "data" -exec rm -rf {} +; cp -a "$STAGING_DIR"/. "$APP_DIR"/; fi; cd "$APP_DIR"; if pm2 describe detailflix >/dev/null 2>&1; then pm2 startOrRestart ecosystem.config.cjs --only detailflix --update-env; else pm2 start ecosystem.config.cjs --only detailflix; fi; pm2 save; node -e "const http=require(\"http\");let tries=0;function check(){tries+=1;const req=http.get(\"http://127.0.0.1:3000/login\",res=>{res.resume();if(res.statusCode&&res.statusCode<500){process.exit(0)}if(tries>=20)process.exit(1);setTimeout(check,1000)});req.on(\"error\",()=>{if(tries>=20)process.exit(1);setTimeout(check,1000)});req.setTimeout(2000,()=>{req.destroy();if(tries>=20)process.exit(1);setTimeout(check,1000);});}check();"'
          for attempt in {1..6}; do
            echo "Remote deploy attempt ${attempt}/6"
            if sshpass -p "$VPS_PASSWORD" ssh \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=20 \
              "$VPS_USER@$VPS_HOST" "$REMOTE_CMD"; then
              echo "Deploy succeeded"
              exit 0
            fi
            echo "Deploy failed (attempt ${attempt})"
            sleep $((attempt * 10))
          done
          echo "Deploy failed after 6 attempts"
          exit 1
