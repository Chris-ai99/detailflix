generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model Customer {
  id     String  @id @default(cuid())
  name   String?
  isBusiness Boolean @default(false)
  companyName String?
  contactFirstName String?
  contactLastName String?
  contactUseZh Boolean @default(false)
  email  String?
  phone  String?
  vatId  String?
  street String?
  zip    String?
  city   String?
  country String?
  notes  String?
  hourlyRateCents Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents   Document[]
  vehicles    Vehicle[]
  attachments CustomerAttachment[]
}

model CustomerAttachment {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  vehicleId  String?
  vehicle    Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  kind       CustomerAttachmentKind @default(GENERAL)
  title      String
  mimeType   String
  sizeBytes  Int
  storagePath String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId, createdAt])
  @@index([vehicleId])
}

model CompanySettings {
  // Single-row settings (per installation)
  id String @id @default("default")

  companyName String
  ownerName   String?
  street      String?
  zip         String?
  city        String?
  phone       String?
  email       String?
  website     String?

  bankName String?
  iban     String?
  bic      String?
  vatId    String?

  noticeRed   String?
  logoDataUrl String?
  workCardAwMinutes Int @default(10)
  workCardHourlyRateCents Int @default(6000)

  updatedAt DateTime @updatedAt
}

model ServiceItem {
  id String @id @default(cuid())

  name     String
  category String?
  unit     String  @default("Stk") // ✅ String braucht ""

  pricingType ServicePricingType @default(AW) // ✅ Enum ohne ""

  awDurationMinutes Int?
  awUnitPriceCents  Int?
  awDefaultQty      Float? @default(1.0)

  hourlyRateCents Int?
  defaultMinutes  Int?

  materialPercent    Int? @default(0)
  materialFixedCents Int? @default(0)

  vatRate Int     @default(19)
  active  Boolean @default(true)

  descriptionHtml String?
  shortText       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vehicle {
  id String @id @default(cuid())

  vin           String?
  make          String?
  model         String?
  year          Int?
  mileage       Int?
  purchaseCents Int?
  notes         String?
  isStock       Boolean @default(false)
  isForSale     Boolean @default(false)
  isSold        Boolean @default(false)
  soldAt        DateTime?
  customerId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents Document[]
  customer  Customer? @relation(fields: [customerId], references: [id])
  attachments CustomerAttachment[]
}

model EmployeeWorkCard {
  id String @id @default(cuid())

  customerId String?
  vehicleId String?
  planRank Int?
  plannedSteps String?
  plannedNote String?
  customerName String?
  vehicleMake String?
  vehicleModel String?
  licensePlate String?
  notes String?
  workDate DateTime @default(now())
  createdByUserId String?
  createdByEmail String?
  assignedToUserId String?
  assignedToLabel String?
  sourceOfferId String?
  sourceOrderId String?
  invoiceDocumentId String?
  billingReadyAt DateTime?
  archivedAt DateTime?

  status EmployeeWorkCardStatus @default(OPEN)
  closedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps EmployeeWorkStep[]

  @@index([status, updatedAt])
  @@index([workDate, status])
  @@index([status, planRank, workDate])
  @@index([assignedToUserId, workDate, status])
  @@index([archivedAt, workDate])
  @@index([customerId, workDate])
  @@index([vehicleId, workDate])
  @@index([invoiceDocumentId])
}

model EmployeeWorkStep {
  id String @id @default(cuid())

  cardId String
  card EmployeeWorkCard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  name String
  startedAt DateTime
  endedAt DateTime?
  durationSeconds Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cardId, startedAt])
  @@index([cardId, endedAt])
}

model EmployeeWorkPlan {
  id String @id @default(cuid())

  memberUserId String
  dayOfWeek Int
  startTime String?
  endTime String?
  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberUserId, dayOfWeek])
  @@index([memberUserId, dayOfWeek])
}

model DocumentDraftCounter {
  id String @id @default(cuid())

  docType DocumentType
  year    Int
  lastSeq Int @default(0)

  updatedAt DateTime @updatedAt

  @@unique([docType, year])
}

model Document {
  id String @id @default(cuid())

  docType   DocumentType
  offerType OfferType?
  docNumber String
  draftNumber String?
  status    DocumentStatus @default(DRAFT) // ✅ Enum ohne ""
  isFinal   Boolean        @default(false)

  issueDate  DateTime  @default(now())
  serviceDate DateTime?
  dueDate    DateTime?
  deliveryDate DateTime?
  validUntil DateTime?
  paidAt     DateTime?
  sentAt     DateTime?
  cancelledAt DateTime?

  taxMode       TaxMode @default(REGULAR_VAT) // ✅ Enum ohne ""
  depositCents  Int?
  notesPublic   String?
  notesInternal String?

  customerId String?
  vehicleId  String?
  vehicleMake String?
  vehicleModel String?
  vehicleVin String?
  vehicleMileage Int?
  creditForId String?
  sourceOfferId String?

  netTotalCents   Int @default(0)
  vatTotalCents   Int @default(0)
  grossTotalCents Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicle  Vehicle?  @relation(fields: [vehicleId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  creditFor Document? @relation("CreditFor", fields: [creditForId], references: [id])
  creditNotes Document[] @relation("CreditFor")
  sourceOffer Document? @relation("SourceOffer", fields: [sourceOfferId], references: [id])
  convertedInvoices Document[] @relation("SourceOffer")

  lines DocumentLine[]
}

model DocumentLine {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id])

  // stabile Reihenfolge im PDF / UI
  position Int @default(1)

  // Snapshot Felder
  title        String
  qty          Float  @default(1)
  unitNetCents Int    @default(0)
  vatRate      Int    @default(19)
  isMarginScheme Boolean @default(false)

  // ✅ NEU (für Step 3 wie dein Screenshot)
  description String?
  discountPct Float   @default(0)

  // berechnete Werte (für PDF/Speed/Consistency)
  lineNetCents   Int @default(0)
  lineVatCents   Int @default(0)
  lineGrossCents Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId])
  @@index([documentId, position])
}

model DocumentCounter {
  id String @id @default(cuid())

  docType DocumentType
  year    Int
  lastSeq Int          @default(0)

  updatedAt DateTime @updatedAt

  @@unique([docType, year])
}

enum ServicePricingType {
  AW
  HOURLY
}

enum DocumentType {
  OFFER
  INVOICE
  PURCHASE_CONTRACT
  CREDIT_NOTE
  STORNO
}

enum OfferType {
  OFFER
  ESTIMATE
}

enum DocumentStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
  CONVERTED
}

enum TaxMode {
  REGULAR_VAT
  MARGIN_SCHEME
  EU_NET_WITH_DEPOSIT
  NON_EU_NET_WITH_DEPOSIT
}

enum CustomerAttachmentKind {
  GENERAL
  VEHICLE_REGISTRATION
  PRIVACY_AGREEMENT_UNSIGNED
  PRIVACY_AGREEMENT_SIGNED
}

enum EmployeeWorkCardStatus {
  OPEN
  CLOSED
}
